#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>
#include <string.h>
#include <string.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <pthread.h>  
#include <semaphore.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#define READ 0

#define WRITE 1
#define MAX 4096
int main() {

    int file_descriptors[2];
    pid_t pid1,pid2,pid3;
    char buf[512];
    char * input;
    
    int num=0;
    int returned_count;
    int dz1=0;
    int dz2=0;
    int rz1=0;
    int rz2=0;
    int val_count;
	int val_full; 
    char * sem_mutex_name="huchi";
	char * sem_count_name="countcount"; 
	
	char * sem_full_name="fulltongbu1";
	char * sem_empty_name="emptytongbu1"; 


    sem_t * mutex = sem_open(sem_mutex_name,O_CREAT | O_RDONLY,0666, 1);
    
    sem_t * empty = sem_open(sem_empty_name,O_CREAT | O_RDONLY, 0666, MAX);
    sem_t * full = sem_open(sem_full_name,O_CREAT | O_RDONLY, 0666, 0);
    
    sem_t * count = sem_open(sem_count_name,O_CREAT | O_RDONLY, 0666, 3);
   
    if(SEM_FAILED == mutex)
    {
      perror("sem_mutex_open error");
      return -1;
    }
    
  
  
    
    pipe(file_descriptors);  /*创建无名管道*/

    if((pid1 = fork()) == -1) { /*创建子进程*/
        printf("Error in fork\n");
        exit(1);
    }
    if(pid1 == 0) {
       
        input="111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111s11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\n";
		     
			  
        dz1=strlen(input);
        dz2=strlen(input);
        while(dz1--){
        	sem_wait(empty);
		}
        
		sem_wait(mutex); 
        close(file_descriptors[READ]);
        printf("pid1:%d in the spawned (child) process write data 111111...:%d\n",getpid(),strlen(input));
        write(file_descriptors[WRITE],input, strlen(input));      
		sem_post(mutex);
		
        while(dz2--){
        	sem_post(full);
		}
		
		sem_wait(count);
        exit(0);
    }



    if ((pid2 = fork()) == -1) {
        printf("ERROR in fork pid2\n");
        exit(1);
    }
    if (pid2 == 0) {
        
       
       
        input="2222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222\n";
		       
			  
        dz1=strlen(input);
        dz2=strlen(input);
        while(dz1--){
        	sem_wait(empty);
		}
        
		sem_wait(mutex); 
        close(file_descriptors[READ]);
        printf("pid2:%d in the spawned (child) process writes data 2222...:%d\n",getpid(),strlen(input));
        write(file_descriptors[WRITE],input, strlen(input));      
		sem_post(mutex);
		
        while(dz2--){
        	sem_post(full);
		}
		
		sem_wait(count);
        exit(0);
    }


    if ((pid3 = fork()) == -1) {
        printf("ERROR in fork pid3\n");
        exit(1);
    }
    if (pid3 == 0) {
       
       
        input="3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\n";
		       
			  
        dz1=strlen(input);
        dz2=strlen(input);
        while(dz1--){
        	sem_wait(empty);
		}
        
		sem_wait(mutex); 
        close(file_descriptors[READ]);
        printf("pid3:%d in the spawned (child) process  write data 3333...:%d\n",getpid(),strlen(input));
        write(file_descriptors[WRITE],input, strlen(input));      
		sem_post(mutex);
		
        while(dz2--){
        	sem_post(full);
		}
		
		sem_wait(count);
        exit(0);
    }
    else {
        
        if(sem_getvalue(count, &val_count)==0){
       	   		printf("the value of count is：%d\n",val_count);
	       }
      
        while(val_count){
        	
        	rz1=sizeof(buf);
        	rz2=sizeof(buf);
        	while(rz1--){
        	     sem_wait(full);
		    }
		    sem_wait(mutex); 
           /*父进程从管道读取子进程写的数据，关闭管道的写端*/
            close(file_descriptors[WRITE]);
            returned_count = (int)read(file_descriptors[READ], buf, sizeof(buf));  
            printf("%d bytes of data received from spawned process: \n%s\n",returned_count, buf);
            
		    sem_post(mutex);
		    
		    num=num+returned_count;
		    while(rz2--){
        	     sem_post(empty);
		    }
		    
		    if(sem_getvalue(count, &val_count)==0){
       	   		printf("the value of count is：%d\n",val_count);
	        }
        }
		
		
		 if(sem_getvalue(full, &val_full)==0){
       	   	printf("the value of full is：%d\n",val_full);
	    }
		
	     while(val_full){
        	
        	
		    sem_wait(mutex); 
           /*父进程从管道读取子进程写的数据，关闭管道的写端*/
            close(file_descriptors[WRITE]);
            returned_count = (int)read(file_descriptors[READ], buf, sizeof(buf));  
            printf("%d bytes of data received from spawned process: \n%s\n",returned_count, buf);
            
		    sem_post(mutex);
		    
		    num=num+returned_count;
		    rz1=returned_count;
        	rz2=returned_count;
        	while(rz1--){
        	     sem_wait(full);
		    }
		    
		    while(rz2--){
        	     sem_post(empty);
		    }
		    
		    if(sem_getvalue(full, &val_full)==0){
       	   		printf("the value of full is：%d\n",val_full);
	        }
        }
       
	    sem_close(mutex);
        sem_unlink(sem_mutex_name);
        sem_close(empty);
        sem_unlink(sem_empty_name); 
        sem_close(full);
        sem_unlink(sem_full_name);
        sem_close(count);
        sem_unlink(sem_count_name); 
        
	    pid1 = waitpid(pid1, NULL, WUNTRACED);
        pid2 = waitpid(pid2, NULL, WUNTRACED);
        pid3 = waitpid(pid3, NULL, WUNTRACED);
        printf("main process pid: %d\n",getpid());
        printf("total read:%d\n",num);
        printf("pid: %d %d %d in the spawning (parent) process...\n",pid1,pid2,pid3);
	
	}
    return 0;
}
